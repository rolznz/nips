NIP-67
======

Nostr Wallet Auth
--------------------

`draft` `optional`

## Rationale

[Nostr Wallet Connect](47.md) is a protocol for talking to a lightning wallet over nostr. It is great but hinges on
having the user copy-paste a wallet connection URI into the app they wish to connect with. This can be a UX hurdle and
often has the user handling sensitive information that they may not understand.

As well, Nostr Wallet Connect has lots of different functions that a wallet may or may not support or an app may or may
not need. This either runs into silent failures or requires the user to understand what functions their wallet supports
and what functions the app needs.

This NIP proposes a new protocol that solves these problems by having the client generate the connection secret and pass the corresponding pubkey to the wallet service to initiate the connection through a user-trusted authorization UI. This way, the private key of the connection secret never leaves the client, and the user receives a "1-click" authorization experience to connect their lightning wallet to a client application.

## Terms

* **client**: Nostr client app on any platform that wants to permissioned access to a user's lightning wallet.
* **user**: The person using the **client**, and wants to connect their wallet to their **client**.
* **wallet service**: A nostr wallet connect capable lightning wallet that the user wants to connect to the app.
* **auth string** a string generated by the **client** to initiate a NIP-47 connection with the **wallet service**.
* **authorization UI** a UI trusted by the **user** that can interact with the **wallet service** to activate a new NIP-47 app connection. How the **authorization UI** interacts with the **wallet service** is outside the scope of this NIP.

## Theory of Operation

1. The **client** would like to interact with the **user**'s lightning wallet on behalf of the **user**. The **client** generates an **auth string** that can be opened in the **authorization UI**.
2. In the **authorization UI** the **user** confirms that they want to connect to the **client**.
3. The **authorization UI** communicates with the **wallet service** to activate a new NIP-47 client app connection, and afterwards re-opens the client.
4. The **client** can now communicate with the **wallet service**.

## Specification

### URI Format

The **auth string** is a `nostr+walletauth://` URI that contains the public key of the NIP-47 connection URI, the requirements of the **client**, and optionally, a NIP-68 client app registration event.

#### Base Path

The **client** generates a nostr keypair and keeps the secret key. The corresponding pubkey is used as the base path of the `nostr+walletauth://` URI. This keypair will be used for NIP-47 communication if the connection is authorized.

#### Required parameters

* `redirect_uri` the URI of the **client** to open when the new NIP-47 app connection is activated. The **wallet service** `pubkey`, `relay`, and optionally `lud-16` will be added by the **authorization UI** so the **client** has everything it needs to communicate with the **wallet service** via NIP-47.

#### Optional Parameters

* `request_methods` A space-separated list of commands that the **client** requires from the **wallet service**. The
  **wallet service** MUST NOT connect if it does not support all of these request methods.

* `notification_types` A space-separated list of notifications that the **client** requires from the **wallet service**. The **wallet service** MUST NOT connect if it does not support all of these notifications.

* `max_amount` A budget (in `millisats`) that the **wallet service** will use to limit the amount of funds that the **client** can spend. The **client** MUST NOT spend more than this amount.

* `budget_renewal` One of `daily`, `weekly`, `monthly`, `yearly` or `never`.

* `expires_at` Connection cannot be used after this date. Unix timestamp in seconds.

* `isolated` If `true`, the connection must be isolated from other activity on the wallet service. The
  **wallet service** MUST NOT connect if it does not support isolated connections.

* `client` URL-encoded, JSON-stringified NIP-68 event. The information in this event can be displayed in the **authorization UI**.

#### Example URI

```sh
nostr+walletauth://b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4?redirect_uri=https%3A%2F%2Fexample.com&request_methods=pay_invoice%20pay_keysend%20make_invoice%20lookup_invoice&max_amount=10000&budget_renewal=daily&client=...
```

## Appendix A: Authorization UIs

### Web-based

The client can launch a URL such as `https://example.com/.well-known/nostr/nip67?nwa=<url-encoded-auth-string>` which the user can confirm the app connection.

A browser extension can also intercept the above URL, decode the `nwa` parameter, and do an app-based flow (see below).

### Native app-based

The client can launch the `nostr+walletauth` URL directly such as `nostr+walletauth://b889ff5b1513b641e2a139f661a661364979c5beee91842f8f0ef42ab558e9d4&redirect_uri=damus://&request_methods=pay_invoice%20pay_keysend%20make_invoice%20lookup_invoice&max_amount=10000&budget_renewal=daily&client=...` which will be opened by a native app on the user's device. Once the user has confirmed, client app can then communicate with the wallet service to activate the connection.